# Session 7 - ACID

## Setup

```
docker run -p 5432:5432 fiitpdt/postgres
```

## Labs

Try benchmarking PostgreSQL write performance with and without synchronous_commit option set.
The metric that you should measure is inserts per seconds - i.e., how many inserts can the database process in 1 second.

Start by writing a benchmarking script in a language of your choice. Here's mine, written in ruby:


```ruby
require 'pg'
require 'securerandom'
require 'benchmark/ips'

conn = PG.connect('postgresql://postgres@localhost:5432/oz')

Benchmark.ips do |x|
  x.report("insert") do
    conn.exec("insert into documents(name, type, created_at, department, contracted_amount) values ('Generated doc #{SecureRandom.hex(10)}', 'MyTy    ↪pe', now(), 'Department #{SecureRandom.hex(10)}', #{(rand * 1_000_000).to_i})")
  end

  x.compare!
end
```

It starts by connecting to the database running in docker container, and then
uses `benchmark-ips` library to evaluate how many inserts per second can it
execute.

If you cannot find a similar library in your language of choice, feel free to write your own benchmark.

Now, run the benchmark against the stock docker image. How many inserts per second did it handle?

Stop the docker container and run it again, but with different options.

```
docker run -p 5432:5432 fiitpdt/postgres postgres -c 'synchronous_commit=off'
```

The above command will run the docker container, but it will explicitely launch
`postgres` command, and pass it a configuration option via the `-c` parameter,
which will disable synchronous commit.

Run the benchmark again. How many inserts per second can it handle now?

Here is the raw output of my script:


```
➜ ruby pgbench.rb
Warming up --------------------------------------
              insert    86.000  i/100ms
Calculating -------------------------------------
              insert    919.723  (± 4.0%) i/s -      4.644k in   5.057989s

➜ ruby pgbench.rb
Warming up --------------------------------------
              insert   662.000  i/100ms
Calculating -------------------------------------
              insert      6.968k (± 4.4%) i/s -     35.086k in   5.045219s
```

Note that the output (and formatting) is generated by the benchmark-ips library.
